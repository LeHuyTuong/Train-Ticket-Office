<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/_customer_layout}">
<head>
    <title>Bước 2: Xác Nhận & Thanh Toán</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        body {
            background: url('/images/train01.jpg') center/cover no-repeat fixed;
            font-family: 'Montserrat', sans-serif;
        }

        .content-container {
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 30px;
            margin: 30px auto;
            max-width: 1000px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
        }

        .page-title {
            font-weight: 700;
            font-size: 28px;
            color: #004a99;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.25s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
            color: #fff;
        }

        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #009ffd, #2a2a72);
            color: #fff;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .card {
            background: rgba(255, 255, 255, 0.85);
            border: none;
            border-radius: 12px;
        }

        .alert-success {
            background: rgba(212, 237, 218, 0.9);
            border-color: rgba(195, 230, 203, 0.9);
        }

        .alert-info {
            background: rgba(209, 236, 241, 0.9);
            border-color: rgba(190, 229, 235, 0.9);
        }

        /* CSS cho bảng chi tiết vé */
        .table {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            overflow: hidden; /* Để bo góc */
        }

        .table thead th {
            background: rgba(0, 0, 0, 0.05);
        }

        /* CSS RESPONSIVE CHO BẢNG */
        @media (max-width: 768px) {
            .table thead {
                display: none;
            }

            .table, .table tbody, .table tr, .table td {
                display: block;
                width: 100%;
            }

            .table tr {
                margin-bottom: 15px;
                border: 1px solid rgba(0, 0, 0, 0.1);
                border-radius: 8px;
            }

            .table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                text-align: right;
                border: none;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }

            .table td:last-child {
                border-bottom: none;
            }

            .table td::before {
                content: attr(data-label);
                font-weight: 600;
                text-align: left;
                margin-right: 10px;
                color: #333;
            }
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="content-container">
        <h2 class="page-title">Bước 2: Xác Nhận & Thanh Toán</h2>

        <div class="alert alert-success">
            <h4 class="alert-heading">Giữ chỗ thành công! (Mã Đơn Hàng: <span th:text="${primaryOrderId}"></span>)</h4>
            <p>Các vé dưới đây đã được giữ chỗ (giữ trong 15 phút). Vui lòng hoàn tất thanh toán cho đơn hàng để xác
                nhận.</p>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Tóm tắt đơn hàng</h5>
                <p class="mb-1">
                    <strong>Số lượng vé:</strong>
                    <span th:text="${totalTickets}"></span>
                </p>
                <p class="mb-1">
                    <strong th:text="${isRoundTrip} ? 'Tổng tiền (Gộp khứ hồi):' : 'Tổng tiền:'"></strong>
                    <span class="fw-bold text-danger fs-5"
                          th:text="${#numbers.formatDecimal(totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VND'">
                    </span>
                </p>
            </div>
        </div>

        <div th:if="${isRoundTrip}" class="alert alert-info">
            <strong>Bạn đang xem đơn hàng khứ hồi.</strong>
            Cả lượt đi và lượt về đã được gộp chung để thanh toán một lần.
        </div>

        <h4 class="mb-3">Chi tiết vé trong đơn hàng</h4>
        <div th:if="${not #lists.isEmpty(bookings)}">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>Mã Đặt Vé</th>
                    <th>Hành Khách</th>
                    <th>Chuyến Tàu</th>
                    <th>Toa (Ghế)</th>
                    <th>Giá vé</th>
                    <th>Trạng thái</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="booking : ${bookings}">
                    <td data-label="Mã Đặt Vé" th:text="${booking.bookingId}"></td>

                    <td data-label="Hành Khách" th:text="${booking.passengerName}"></td>

                    <td data-label="Chuyến Tàu" th:text="${booking.trip.train.code}"></td>

                    <td data-label="Ghế" th:text="|${booking.seat.carriage.name} (${booking.seat.seatNumber})|"></td>

                    <td data-label="Giá vé"
                        th:text="${#numbers.formatDecimal(booking.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"></td>

                    <td data-label="Trạng thái">
                        <span th:if="${booking.status.name() == 'BOOKED'}" class="badge bg-warning text-dark">Chờ thanh toán</span>
                        <span th:if="${booking.status.name() == 'PAID'}" class="badge bg-success">Đã thanh toán</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-4">
            <h4 class="mb-3">Bước 3: Hoàn tất thanh toán (cho cả đơn hàng)</h4>

            <a th:if="${totalPrice.compareTo(T(java.math.BigDecimal).ZERO) > 0}"
               th:href="@{/payments/orders/{id}(id=${primaryOrderId})}"
               class="btn btn-success btn-lg">
                <i class="bi bi-credit-card-fill"></i> Thanh toán toàn bộ đơn hàng (VNPay)
            </a>

            <a th:if="${totalPrice.compareTo(T(java.math.BigDecimal).ZERO) == 0}"
               th:href="@{/bookings}"
               class="btn btn-success btn-lg">
                <i class="bi bi-check-circle-fill"></i> (Miễn phí) Xác nhận và Về "Vé của tôi"
            </a>

            <hr class="my-4">
            <a th:href="@{/bookings}" class="btn btn-primary">
                <i class="bi bi-ticket-detailed"></i> Đến "Vé Của Tôi" (Xem tất cả)
            </a>
        </div>
    </div>

</div>
</body>
</html>
